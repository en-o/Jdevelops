# =============== 完整的SQL异常处理配置示例 ===============

# Spring Boot 基础配置
spring:
  application:
    name: renewpwd-datasource-demo

  # 数据源基础配置
  datasource:
    url: jdbc:mysql://localhost:3306/test_db?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
    username: ${DB_USERNAME:root}
    password: ${DB_PASSWORD:password}
    driver-class-name: com.mysql.cj.jdbc.Driver

    # HikariCP 连接池配置
    hikari:
      pool-name: RenewpwdHikariPool
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
      leak-detection-threshold: 60000
      connection-test-query: SELECT 1

# =============== SQL异常处理完整配置 ===============
renewpwd:
  datasource:
    exception-handling:
      # ===== 基础功能开关 =====
      # 是否启用SQL异常处理代理 (默认: true)
      enabled: true
      # 是否启用告警功能 (默认: true)
      alert-enabled: true

      # ===== 日志配置 =====
      # 日志记录级别: ERROR/WARN/DEBUG/INFO (默认: ERROR)
      log-level: ERROR
      # 是否记录SQL执行成功的日志 (默认: false，开发环境可开启)
      log-successful-operations: false
      # 是否记录SQL参数 (默认: true，生产环境建议关闭)
      log-parameters: true

      # ===== 性能监控阈值 =====
      # 慢查询阈值(毫秒) - 超过此时间的SQL会被记录 (默认: 3000)
      slow-query-threshold: 3000
      # 连接超时时间(毫秒) (默认: 30000)
      connection-timeout: 30000
      # 查询超时时间(毫秒) (默认: 60000)
      query-timeout: 60000
      # 长事务阈值(毫秒) - 超过此时间的事务会被记录 (默认: 30000)
      long-transaction-threshold: 30000

      # ===== 异常处理策略 =====
      # 死锁重试次数 (默认: 3)
      deadlock-retry-count: 3
      # 告警发送间隔(秒) - 防止告警轰炸 (默认: 300)
      alert-interval-seconds: 300
      # 异常统计窗口大小(秒) (默认: 60)
      exception-statistics-window: 60
      # 异常频率告警阈值(次/分钟) (默认: 10)
      exception-frequency-threshold: 10

      # ===== 连接监控配置 =====
      # 是否启用连接泄露检测 (默认: true)
      enable-connection-leak-detection: true
      # 连接泄露检测阈值(毫秒) (默认: 60000)
      connection-leak-detection-threshold: 60000
      # 是否启用连接池监控 (默认: true)
      enable-connection-pool-monitoring: true
      # 连接池使用率告警阈值(百分比) (默认: 80)
      connection-pool-usage-threshold: 80

      # ===== 安全监控配置 =====
      # 是否启用SQL注入检测 (默认: true)
      enable-sql-injection-detection: true
      # 危险SQL关键字列表 - 用于SQL注入检测
      dangerous-sql-keywords:
        - "drop table"
        - "delete from"
        - "truncate"
        - "alter table"
        - "create table"
        - "insert into"
        - "update set"
        - "grant"
        - "revoke"
        - "exec"
        - "execute"
        - "sp_"
        - "xp_"
        - "union select"
        - "script"
        - "javascript"
        - "/*"
        - "*/"
        - "--"
        - "char("
        - "convert("
        - "cast("

      # ===== 批量操作监控 =====
      # 是否启用批量操作监控 (默认: true)
      enable-batch-monitoring: true
      # 批量操作大小阈值 - 超过此大小会特别关注 (默认: 1000)
      batch-size-threshold: 1000

      # ===== 事务监控配置 =====
      # 是否启用事务监控 (默认: true)
      enable-transaction-monitoring: true

      # ===== 关键SQL状态码配置 =====
      # 需要特别关注的SQL状态码 - 这些会被标记为关键异常
      critical-sql-states:
        - "40001"  # 死锁 (通用)
        - "40P01"  # PostgreSQL死锁
        - "08001"  # 连接失败
        - "08006"  # 连接异常
        - "08S01"  # MySQL连接异常
        - "28000"  # 无效的授权规范/权限错误
        - "23000"  # 完整性约束违反
        - "23505"  # 唯一约束违反 (PostgreSQL)
        - "42000"  # 语法错误
        - "42601"  # 语法错误 (PostgreSQL)

# =============== Spring Boot Actuator 配置 ===============
management:
  # 启用所有端点
  endpoints:
    web:
      exposure:
        include: "*"
      base-path: /actuator

  # 健康检查配置
  health:
    # 显示详细健康信息
    show-details: always
    # 显示组件信息
    show-components: always

  # 端点配置
  endpoint:
    # 健康检查端点
    health:
      enabled: true
    # 信息端点
    info:
      enabled: true
    # 自定义SQL异常处理端点
    sql-exception-handling:
      enabled: true

# =============== 日志配置 ===============
logging:
  level:
    root: INFO
    # SQL异常处理相关日志
    cn.tannn.jdevelops.renewpwd.refresh: DEBUG
    cn.tannn.jdevelops.renewpwd.refresh.proxy: INFO
    cn.tannn.jdevelops.renewpwd.refresh.actuator: DEBUG

    # HikariCP日志
    com.zaxxer.hikari: DEBUG
    com.zaxxer.hikari.HikariConfig: DEBUG
    com.zaxxer.hikari.HikariDataSource: INFO

    # SQL相关日志
    org.springframework.jdbc: DEBUG
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE

  # 日志格式
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level [%logger{50}] - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level [%logger{50}] - %msg%n"

  # 日志文件
  file:
    name: logs/renewpwd-datasource.log
    max-size: 100MB
    max-history: 30

# =============== 应用信息配置 ===============
info:
  app:
    name: ${spring.application.name}
    version: 2.0.0
    description: "SQL异常全局拦截数据源配置"
  build:
    time: "@timestamp@"
  sql-exception-handling:
    version: 2.0.0
    features:
      - "全局SQL异常拦截"
      - "慢查询检测"
      - "死锁检测"
      - "连接泄露检测"
      - "SQL注入检测"
      - "批量操作监控"
      - "事务监控"
      - "连接池监控"
      - "智能告警"

---
# =============== 开发环境配置 ===============
spring:
  config:
    activate:
      on-profile: dev

renewpwd:
  datasource:
    exception-handling:
      # 开发环境开启详细日志
      log-level: DEBUG
      log-successful-operations: true
      log-parameters: true
      # 降低慢查询阈值便于测试
      slow-query-threshold: 1000
      # 关闭告警避免干扰开发
      alert-enabled: false
      # 降低各种阈值便于测试
      connection-timeout: 10000
      long-transaction-threshold: 10000
      batch-size-threshold: 100

logging:
  level:
    cn.tannn.jdevelops.renewpwd.refresh: TRACE

---
# =============== 生产环境配置 ===============
spring:
  config:
    activate:
      on-profile: prod

jdevelops:
  renewpwd:
    exception:
      # 生产环境配置
      log-level: ERROR
      log-successful-operations: false
      # 生产环境不记录敏感参数
      log-parameters: false
      # 提高慢查询阈值
      slow-query-threshold: 5000
      # 启用告警
      alert-enabled: true
      # 增加告警间隔避免轰炸
      alert-interval-seconds: 600
      # 提高异常频率阈值
      exception-frequency-threshold: 5
      # 生产环境更严格的监控
      connection-pool-usage-threshold: 90
      connection-leak-detection-threshold: 30000

# 生产环境只暴露必要的端点
management:
  endpoints:
    web:
      exposure:
        include: health,info,sql-exception-handling
  health:
    show-details: when-authorized

logging:
  level:
    root: WARN
    cn.tannn.jdevelops.renewpwd.refresh: INFO
    cn.tannn.jdevelops.renewpwd.refresh.proxy: WARN

---
# =============== 测试环境配置 ===============
spring:
  config:
    activate:
      on-profile: test

jdevelops:
  renewpwd:
    exception:
      # 测试环境配置
      log-level: INFO
      log-successful-operations: true
      log-parameters: false  # 测试环境也不记录参数
      slow-query-threshold: 2000
      alert-enabled: false  # 测试环境关闭告警
      # 测试环境可以更宽松一些
      deadlock-retry-count: 5
      exception-frequency-threshold: 20

logging:
  level:
    cn.tannn.jdevelops.renewpwd.refresh: DEBUG
