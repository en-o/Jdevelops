`<font style="color:#a31615;">jdevelops-dals-renewpwd</font>` 是一个用于数据库密码加密、解密、**<font style="color:#DF2A3F;">过期检测与自动刷新管理</font>**的 Java 组件，支持 Spring Boot 自动装配，适用于提升数据库密码安全性和自动化管理。  目前只支持

+ **<font style="color:#74B602;">MYSQL</font>**
+ **<font style="color:#74B602;">kingbase8</font>**
+ **<font style="color:#74B602;">postgreSql</font>**



> 目前我们都是单体+内网项目，无法用到互联网组件比如阿里的MSE，最近遇到好几个项目有密码过期策略的设置，所有有了这个，这个是我从我自己一个还未完善的单机版配置中心了抽取出来的功能。
>



规划

1. 新增datasource其他参数的更换处理，必须发送连接异常更换备用库

## 快速开始 
> [https://github.com/en-o/Jdevelops-Example/tree/main/dals-renewpwd](https://github.com/en-o/Jdevelops-Example/tree/main/dals-renewpwd)
>

1.  在你的 `<font style="color:#a31615;">pom.xml</font>` 中添加：  

```xml
<dependency>
    <groupId>cn.tannn.jdevelops</groupId>
    <artifactId>jdevelops-dals-renewpwd</artifactId>
    <version>1.0.2-SNAPSHOT</version>
</dependency>
```

2.  在 Spring Boot 启动类上添加注解：  

```java
@cn.tannn.jdevelops.renewpwd.annotation.EnableRenewpwd
@SpringBootApplication
public class YourApplication { ... }
```



### 数据库密码加密与解密 
1. 加密密码（密钥必须为 16 字节，否则会抛出异常。

```java
String encrypted = AESUtil.encrypt("yourPassword"); // 使用默认密钥
// 或 自定密钥的话需要在配置文件中配置密钥
String encrypted = AESUtil.encrypt("yourPassword", "your16bytekey123"); // 自定义密钥
```

2. 数据库配置文件中使用加密密码

```properties
spring.datasource.password=ENC(加密后的密文)
```

### 密码过期检测与自动刷
1. 只要没有主动禁止`<font style="color:rgb(163, 22, 21);background-color:rgba(0, 0, 0, 0.06);">jdevelops-dals-renewpwd</font>`就会自动在查询错误的时候触发
    1. <font style="color:#080808;background-color:#ffffff;">mysql： e.getErrorCode() =  1820 / 1862  :  使用 备份/主 密码重置密码过期时间</font>
    2. <font style="color:rgb(8, 8, 8);">mysql： e.getErrorCode() = </font><font style="color:#080808;background-color:#ffffff;">1045 </font><font style="color:rgb(8, 8, 8);"> :  使用 备份/主 密码重置密码，重置失败业务执行处理（密码被人为外部修改后的兜底</font>
    3. <font style="color:#080808;background-color:#ffffff;">pgsql类：e.getSQLState() = 28P01 && </font><font style="color:rgb(8, 8, 8);"> e.getErrorCode() = 0 </font>
2. 我没有处理当前的查询错误，接口会直接报错，重新请求一次就正常了

### 其他配置说明
> 特别注意： **<font style="color:#DF2A3F;">PGSQL类的数据库</font>****<font style="color:#DF2A3F;background-color:#ffffff;">用于在密码续命时，提供一个超级账户来执行，注意这个账户</font>****<font style="color:#2A4200;background-color:#ffffff;">不允许修改和过期</font>**
>

```yaml
jdevelops:
  renewpwd: # 都可以不写
    backup-password: "ENC(+7TSMol4SfIFVGkPffTlqw==)"
#    pwd-encrypt-key: 1234567890abcdef #必须16位
#    backup-password: "123"
#    enabled: true # 默认true
jdevelops:
  renewpwd:
#    backup-password: "ENC(+7TSMol4SfIFVGkPffTlqw==)"
    backup-password: "123"
#    enabled: false
#    pwd-encrypt-key: 1234567890abcdef
#    enabled: true # 默认true
    root:
      username: root
      password: root


```





# 时序图
![](https://cdn.nlark.com/yuque/0/2025/png/1642320/1755616147700-4f47b7e1-1b67-4923-8cc3-db3670fd6a5f.png)





